<!DOCTYPE html>
<html lang="en" data-theme="obsidian">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflicts - 7D2D Ecosystem</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
<nav class="site-nav">
  <div class="nav-brand">7D2D Ecosystem</div>
  <a href="index.html" class="nav-item">Dashboard</a>
  <a href="entities.html" class="nav-item">Entities</a>
  <a href="mods.html" class="nav-item">Mods</a>
  <a href="conflicts.html" class="nav-item active">Conflicts</a>
  <a href="dependencies.html" class="nav-item">Dependencies</a>
  <a href="csharp.html" class="nav-item">C# Analysis</a>
  <a href="glossary.html" class="nav-item">Glossary</a>
  <select class="theme-select" onchange="setTheme(this.value)">
    <option value="obsidian">Obsidian</option>
    <option value="graphite">Graphite</option>
  </select>
</nav>

<div class="page-container">
<div class="page-header">
  <h1>Conflict Center</h1>
  <p>Identify entities modified by multiple mods and potential compatibility issues</p>
</div>
<div class="severity-tabs" id="severity-tabs">
<button class="severity-tab active" data-severity="" onclick="filterBySeverity('')">ALL<span class="count">(2)</span></button>
<button class="severity-tab" data-severity="High" onclick="filterBySeverity('High')" style="border-color: var(--severity-high);">HIGH<span class="count">(0)</span></button>
<button class="severity-tab" data-severity="Medium" onclick="filterBySeverity('Medium')" style="border-color: var(--severity-medium);">MEDIUM<span class="count">(2)</span></button>
<button class="severity-tab" data-severity="Low" onclick="filterBySeverity('Low')" style="border-color: var(--severity-low);">LOW<span class="count">(0)</span></button>
</div>
<div class="filter-bar">
  <input type="text" class="filter-search" id="conflict-search" placeholder="Search entities or mods..." oninput="filterConflicts()">
  <label class="fuzzy-toggle"><input type="checkbox" id="fuzzy-toggle" checked onchange="filterConflicts()"> Fuzzy</label>
</div>
<div id="conflict-results"></div>
<div style="margin-top: 2rem;">
<h2 style="margin-bottom: 1rem;">Load Order Sensitive Properties</h2>
<p class="text-muted" style="margin-bottom: 1rem;">These properties are set by multiple mods. The last mod in load order wins.</p>
<div id="property-conflicts"></div>
</div>

</div>
<script>

// Fuzzy search scoring - matches characters in order, not necessarily adjacent
function fuzzyScore(query, target) {
  if (!query) return 1;
  query = query.toLowerCase();
  target = target.toLowerCase();
  let qi = 0, score = 0, lastMatch = -1;
  for (let ti = 0; ti < target.length && qi < query.length; ti++) {
    if (target[ti] === query[qi]) {
      score += (ti === lastMatch + 1) ? 2 : 1; // Bonus for consecutive
      lastMatch = ti;
      qi++;
    }
  }
  return qi === query.length ? score : 0;
}

// Generic search helper
function searchItems(query, items, getSearchText) {
  if (!query) return items.slice(0, 20);
  return items
    .map(item => ({ item, score: fuzzyScore(query, getSearchText(item)) }))
    .filter(x => x.score > 0)
    .sort((a, b) => b.score - a.score)
    .map(x => x.item);
}

// Theme persistence
function initTheme() {
  const saved = localStorage.getItem('7d2d-theme') || 'obsidian';
  document.documentElement.dataset.theme = saved;
  const select = document.querySelector('.theme-select');
  if (select) select.value = saved;
}

function setTheme(theme) {
  document.documentElement.dataset.theme = theme;
  localStorage.setItem('7d2d-theme', theme);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initTheme);

// Debounce helper for search
function debounce(fn, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

// Show/hide more items
function toggleShowMore(btn, containerId, allItems, renderFn) {
  const container = document.getElementById(containerId);
  const showAll = btn.dataset.expanded !== 'true';

  if (showAll) {
    container.innerHTML = allItems.map(renderFn).join('');
    btn.textContent = 'Show Less';
    btn.dataset.expanded = 'true';
  } else {
    container.innerHTML = allItems.slice(0, 20).map(renderFn).join('');
    btn.textContent = `Show All (${allItems.length})`;
    btn.dataset.expanded = 'false';
  }
}


// Inline JSON - simple, works offline
// FUTURE LAZY LOADING: Replace with fetch() call to ./data/conflict_data.json
const CONFLICT_DATA = [{"entityType":"item","entityName":"gunHandgunT1Pistol","riskLevel":"Medium","riskReason":"Multiple mods set different values for: Magazine_size","modActions":[{"modName":"_XmlTestMod","operation":"insertBefore","xpath":"/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]","propertyName":"Magazine_size","newValue":"gunHandgunT1Pistol","elementContent":"\u003CinsertBefore xpath=\u0022/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]\u0022\u003E\r\n  \u003Cproperty name=\u0022ReloadSpeedBonus\u0022 value=\u00220.15\u0022 /\u003E\r\n\u003C/insertBefore\u003E","filePath":"items.xml","lineNumber":54},{"modName":"_ConflictTestMod1","operation":"set","xpath":"/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value","propertyName":"Magazine_size","newValue":"20","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value\u0022\u003E20\u003C/set\u003E","filePath":"items.xml","lineNumber":8},{"modName":"_ConflictTestMod2","operation":"set","xpath":"/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value","propertyName":"Magazine_size","newValue":"12","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value\u0022\u003E12\u003C/set\u003E","filePath":"items.xml","lineNumber":8},{"modName":"_XmlTestMod","operation":"set","xpath":"/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value","propertyName":"Magazine_size","newValue":"15","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027gunHandgunT1Pistol\u0027]/property[@name=\u0027Magazine_size\u0027]/@value\u0022\u003E15\u003C/set\u003E","filePath":"items.xml","lineNumber":12}]},{"entityType":"item","entityName":"meleeToolRepairT1AxeStone","riskLevel":"Medium","riskReason":"Multiple mods set different values for: DamageBlock","modActions":[{"modName":"_XmlTestMod","operation":"insertAfter","xpath":"/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]","propertyName":"DamageBlock","newValue":"meleeToolRepairT1AxeStone","elementContent":"\u003CinsertAfter xpath=\u0022/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]\u0022\u003E\r\n  \u003Cproperty name=\u0022DamageBlockPenetration\u0022 value=\u00220.1\u0022 /\u003E\r\n\u003C/insertAfter\u003E","filePath":"items.xml","lineNumber":49},{"modName":"_ConflictTestMod1","operation":"set","xpath":"/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value","propertyName":"DamageBlock","newValue":"50","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value\u0022\u003E50\u003C/set\u003E","filePath":"items.xml","lineNumber":5},{"modName":"_ConflictTestMod2","operation":"set","xpath":"/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value","propertyName":"DamageBlock","newValue":"75","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value\u0022\u003E75\u003C/set\u003E","filePath":"items.xml","lineNumber":5},{"modName":"_XmlTestMod","operation":"set","xpath":"/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value","propertyName":"DamageBlock","newValue":"42","elementContent":"\u003Cset xpath=\u0022/items/item[@name=\u0027meleeToolRepairT1AxeStone\u0027]/property[@name=\u0027DamageBlock\u0027]/@value\u0022\u003E42\u003C/set\u003E","filePath":"items.xml","lineNumber":9}]}];


// Inline JSON - simple, works offline
// FUTURE LAZY LOADING: Replace with fetch() call to ./data/prop_conflict_data.json
const PROP_CONFLICT_DATA = [{"entityType":"item","entityName":"gunHandgunT1Pistol","propertyName":"Magazine_size","setters":[{"modName":"_ConflictTestMod1","value":"20"},{"modName":"_ConflictTestMod2","value":"12"},{"modName":"_XmlTestMod","value":"15"}]},{"entityType":"item","entityName":"meleeToolRepairT1AxeStone","propertyName":"DamageBlock","setters":[{"modName":"_ConflictTestMod1","value":"50"},{"modName":"_ConflictTestMod2","value":"75"},{"modName":"_XmlTestMod","value":"42"}]}];


let currentSeverity = '';

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function filterBySeverity(severity) {
  currentSeverity = severity;

  // Update tab active state
  document.querySelectorAll('.severity-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.severity === severity);
  });

  filterConflicts();
}

function filterConflicts() {
  const query = document.getElementById('conflict-search').value;
  const useFuzzy = document.getElementById('fuzzy-toggle').checked;

  let filtered = CONFLICT_DATA.filter(c => {
    if (currentSeverity && c.riskLevel !== currentSeverity) return false;
    return true;
  });

  if (query) {
    if (useFuzzy) {
      filtered = filtered
        .map(c => ({ conflict: c, score: fuzzyScore(query, c.entityName) }))
        .filter(x => x.score > 0)
        .sort((a, b) => b.score - a.score)
        .map(x => x.conflict);
    } else {
      const q = query.toLowerCase();
      filtered = filtered.filter(c => {
        const searchText = c.entityName + ' ' + c.entityType + ' ' + c.modActions.map(a => a.modName).join(' ');
        return searchText.toLowerCase().includes(q);
      });
    }
  }

  renderConflicts(filtered);
}

function renderConflicts(conflicts) {
  const container = document.getElementById('conflict-results');

  if (conflicts.length === 0) {
    container.innerHTML = '<p class="text-muted">No conflicts match the current filters.</p>';
    return;
  }

  let html = '';
  conflicts.forEach((c, idx) => {
    html += '<details>';
    html += '<summary>';
    html += getSeverityBadge(c.riskLevel);
    html += '<span class="tag tag-type">' + escapeHtml(c.entityType) + '</span>';
    html += '<span style="flex: 1;">' + escapeHtml(c.entityName) + '</span>';
    html += '<span class="text-dim" style="font-size: 12px;">' + c.modActions.length + ' mods</span>';
    html += '</summary>';
    html += '<div class="details-body compact">';
    html += '<p class="text-muted compact-margin">' + escapeHtml(c.riskReason) + '</p>';

    // Group actions by property
    const grouped = {};
    c.modActions.forEach(a => {
      const key = a.propertyName || a.operation || 'other';
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(a);
    });

    // Render grouped
    Object.keys(grouped).forEach(propKey => {
      const actions = grouped[propKey];
      html += '<div class="conflict-group">';
      html += '<div class="group-header"><code>' + escapeHtml(propKey) + '</code> <span class="text-dim">(' + actions.length + ' mods)</span></div>';
      html += '<div class="conflict-stack">';
      actions.forEach(a => {
        html += '<div class="conflict-item">';
        html += '<div class="conflict-item-header">';
        html += '<span class="tag ' + getOpClass(a.operation) + ' compact-tag">' + escapeHtml(a.operation) + '</span>';
        html += '<a href="mods.html?search=' + encodeURIComponent(a.modName) + '" class="mod-link">' + escapeHtml(a.modName) + '</a>';
        html += '<code class="source-ref">' + escapeHtml(a.filePath || '') + ':' + (a.lineNumber || '') + '</code>';
        html += '</div>';
        if (a.xpath) html += '<pre class="xpath-inline">' + escapeHtml(a.xpath) + '</pre>';
        if (a.newValue) html += '<div class="value-inline">→ <code>' + escapeHtml(a.newValue) + '</code></div>';
        if (a.elementContent) html += '<details class="xml-expand"><summary>XML</summary><pre class="xml-inline">' + escapeHtml(a.elementContent) + '</pre></details>';
        html += '</div>';
      });
      html += '</div></div>';
    });

    html += '<div class="conflict-links">';
    html += '<a href="entities.html?search=' + encodeURIComponent(c.entityName) + '">Entity details →</a>';
    html += '</div>';
    html += '</div></details>';
  });

  container.innerHTML = html;
}

function renderActionDetail(a) {
  let html = '<div class="conflict-detail-compact">';
  html += '<code class="source-line">' + escapeHtml(a.filePath || '') + (a.lineNumber ? ':' + a.lineNumber : '') + '</code>';
  if (a.xpath) html += '<pre class="xpath-compact">' + escapeHtml(a.xpath) + '</pre>';
  if (a.newValue) html += '<div class="value-compact">= <code>' + escapeHtml(a.newValue) + '</code></div>';
  if (a.elementContent) html += '<pre class="xml-compact">' + escapeHtml(a.elementContent) + '</pre>';
  if (!a.xpath && !a.newValue && !a.elementContent) html += '<span class="text-dim">No detail</span>';
  html += '</div>';
  return html;
}

function toggleActionDetail(btn, conflictIdx, actionIdx) {
  const row = document.getElementById('action-detail-' + conflictIdx + '-' + actionIdx);
  if (row.style.display === 'none') {
    row.style.display = 'table-row';
    btn.textContent = 'Hide Code';
  } else {
    row.style.display = 'none';
    btn.textContent = 'View Code';
  }
}

function getSeverityBadge(level) {
  const cls = level === 'High' ? 'tag-high' : level === 'Medium' ? 'tag-medium' : level === 'Low' ? 'tag-low' : 'tag-info';
  return '<span class="tag ' + cls + '">' + level + '</span>';
}

function getOpClass(op) {
  if (op === 'remove') return 'tag-high';
  if (op === 'set' || op === 'setattribute') return 'tag-medium';
  return 'tag-low';
}

function renderPropertyConflicts() {
  const container = document.getElementById('property-conflicts');
  if (!container || PROP_CONFLICT_DATA.length === 0) return;

  let html = '<table class="data-table">';
  html += '<thead><tr><th>Entity</th><th>Property</th><th>Mods (in order)</th></tr></thead>';
  html += '<tbody>';

  PROP_CONFLICT_DATA.slice(0, 50).forEach(p => {
    html += '<tr>';
    html += '<td><a href="entities.html?search=' + encodeURIComponent(p.entityName) + '">';
    html += '<span class="tag tag-type">' + escapeHtml(p.entityType) + '</span> ' + escapeHtml(p.entityName) + '</a></td>';
    html += '<td><code>' + escapeHtml(p.propertyName) + '</code></td>';
    html += '<td class="text-muted" style="font-size: 12px;">';
    html += p.setters.map(s => '<a href="mods.html?search=' + encodeURIComponent(s.modName) + '">' + escapeHtml(s.modName) + '</a>').join(' → ');
    html += '</td></tr>';
  });

  if (PROP_CONFLICT_DATA.length > 50) {
    html += '<tr><td colspan="3" class="text-dim">... and ' + (PROP_CONFLICT_DATA.length - 50) + ' more</td></tr>';
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  filterConflicts();
  renderPropertyConflicts();
});


</script>
</body>
</html>